#!/usr/bin/env bash

source "${CS_ROOT}/${CS_NAME}/lib/install"

target_package="$1"

arrayPkgFiles=()
readarray -t arrayPkgFiles < <(find "${CS_PACKAGES_DIR}" -type f -printf '%f\n')

if [[ "${#arrayPkgFiles[@]}" -eq 0 ]] ; then
    printf -- 'No packages available\n'
    exit
fi

arrayTargetPkg=()

for pkg in "${arrayPkgFiles[@]}" ; do

    pkg_name_ver="${pkg%.tar.xz}"
    pkg_name=$(printf "${pkg::-1}" | sed 's#[^-]*$##') # remove everything after last - char
    pkg_name="${pkg_name::-1}" # remove - leftover at end of string

    if [[ "$pkg_name" == "$target_package" ]] ; then
        arrayTargetPkg+=($pkg_name_ver)
    fi

done

if [[ "${#arrayTargetPkg[@]}" -eq 0 ]] ; then
    printf -- 'Package not found for %s\n' "$target_package"
    exit

elif [[ "${#arrayTargetPkg[@]}" -eq 1 ]] ; then
    printf -- 'Package version is %s. Proceed? [y|n] ' "${arrayTargetPkg[0]##*-}"
    read -r ans

    if [[ "$ans" != 'y' ]] ; then
        exit
    fi

    unpack_tarball "${arrayTargetPkg[0]}"

elif [[ "${#arrayTargetPkg[@]}" -gt 1 ]] ; then

    printf -- '==> Multiple packages found\n'

    declare -i count
    count=0

    for pkg in "${arrayTargetPkg[@]}" ; do
        printf -- "[$count] %s\n" "$pkg"
        count+=1
    done

    unset number
    until [[ $number == +([0-9]) ]] ; do
        read -r -p 'Choose an index number: ' number
    done

    if [[ $number -gt $(($count-1)) ]] ; then
        printf -- 'error: index out of rage\n'
        exit

    else
        unpack_tarball "${arrayTargetPkg[$number]}"
    fi
fi
