#!/usr/bin/env bash

set -o allexport
# Filesystem
CS_ROOT="$HOME/.local/opt"
CS_BIN_DIR="${CS_ROOT}/bin"
CS_ETC_DIR="${CS_ROOT}/etc"
CS_VAR_DIR="${CS_ROOT}/var"
# Upstream
CS_NAME="dcc-tools"
CS_KNOWN_BUCKETS="${CS_ROOT}/${CS_NAME}/buckets"
# Downstream
CS_BUCKETS_DIR="${CS_VAR_DIR}/buckets"
CS_PACKAGES_DIR="${CS_VAR_DIR}/packages"
set +o allexport

CS_CONFIGS_FILE="${CS_ROOT}/${CS_NAME}/${CS_NAME}.cfg"
if [[ -f "${CS_ETC_DIR}/${CS_NAME}.cfg" ]] ; then
    CS_CONFIGS_FILE="${CS_ETC_DIR}/${CS_NAME}.cfg"
fi

for arg in "$@" ; do
    case arg in
        --config)
            shift
            export CS_CONFIGS_FILE="$1"
            shift
            ;;
        --*|-*)
            printf -- 'error: %s: unkown option\n' "$1"
            exit
            ;;
    esac
done

if [[ ! -f "$CS_CONFIGS_FILE" ]] ; then
    printf -- 'error: configuration file not found\n'
    exit
else
    set -o allexport
    source "$CS_CONFIGS_FILE"
    set +o allexport
fi

case "$1" in
    list)
        exec "${CS_ROOT}/${CS_NAME}/libexec/list"
        ;;
    bucket)
        shift
        exec "${CS_ROOT}/${CS_NAME}/libexec/bucket" "$@"
        ;;
    build)
        shift
        exec "${CS_ROOT}/${CS_NAME}/libexec/build" "$@"
        ;;
    *)
        printf -- 'error: %s: unknown command\n' "$1"
        exit
        ;;
esac
